<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Setting up a React+TypeScript frontend with Webpack — Part 2
        
    </title><meta content="Setting up a React+TypeScript frontend with Webpack — Part 2" property=og:title><meta content="How to quickly get started with a React/TypeScript project using Webpack: the production environment" property=og:description><meta content="How to quickly get started with a React/TypeScript project using Webpack: the production environment" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://ashang.github.io/zz/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ashang.github.io/zz/atom.xml rel=alternate title=atbb type=application/atom+xml><link href=https://ashang.github.io/zz/theme/light.css rel=stylesheet><link href=https://ashang.github.io/zz/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://ashang.github.io/zz/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ashang.github.io/zz/>atbb</a><div class=socials><a class=social href=https://github.com/ashang/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=$BASE_URL/search/ style=margin-left:.7em>Search</a><a href=/notes style=margin-left:.7em>/notes</a><a href=/posts style=margin-left:.7em>/posts</a><a href=/gallery style=margin-left:.7em>/gallery</a><a href=/tags style=margin-left:.7em>/tags</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://ashang.github.io/zz/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Setting up a React+TypeScript frontend with Webpack — Part 2<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2019-11-01</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#node-env-production-in-webpack>NODE_ENV=production in Webpack</a><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#splitting-chunks>Splitting chunks</a> <ul><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#bundle-splitting>Bundle splitting</a><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#code-splitting>Code splitting</a><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#analyzing-bundles>Analyzing bundles</a></ul><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#extracting-css>Extracting CSS</a><li><a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/#conclusion>Conclusion</a></ul><section class=body><p>In this article, we are going to turn our <a href=https://ashang.github.io/zz/posts/react-typescript-webpack-2/2019-10-29_react-typescript-webpack-1.md>local environment setup</a> into a production-ready setup. Thanks to improvements in recent Webpack versions, it is now straightforward.<h2 id=node-env-production-in-webpack>NODE_ENV=production in Webpack</h2><p>The majority of JavaScript projects use the <code>NODE_ENV</code> variable to enable optimizations and remove debug code. If you need to support Windows, setting an environment variable directly in the script the UNIX way is not going to work. You can install <a href=https://www.npmjs.com/package/cross-env>cross-env</a> to handle cross-platform environment variables. The script in that case is <code>"build:prod": "cross-env NODE_ENV=production webpack"</code>. Again, if you do not need Windows support, simply remove the <code>cross-env</code> from the script.<p>Now there are two ways to proceed:<ol><li>split the configuration in multiple files and merge them with something like <a href=https://www.npmjs.com/package/webpack-merge>webpack-merge</a><li>keep everything in one file and use JavaScript to toggle things</ol><p>I prefer the second approach as I find it more readable and doesn't require additional dependencies. You can judge for yourself by looking at the <a href=https://github.com/Keats/webpack-react-typescript/blob/master/webpack.config.js>final result</a>.<p>As mentioned before, Webpack has been making things easier. With the introduction of <a href=https://webpack.js.org/configuration/mode/>mode</a>, it is easy to get a production-ready bundle:<pre class=language-diff data-lang=diff style=background:#0f1419;color:#bfbab0><code class=language-diff data-lang=diff><span>diff --git a/webpack.config.js b/webpack.config.js
</span><span>index 53c39f2..b4d6e11 100644
</span><span style=color:#c594c5>--- a/webpack.config.js
</span><span style=color:#c594c5>+++ b/webpack.config.js
</span><span style=color:#c594c5>@@ -4,9 +4,11 @@ </span><span style=color:#59c2ff>const HtmlWebpackPlugin = require("html-webpack-plugin");
</span><span> const ForkTsCheckerWebpackPlugin = require("fork-ts-checker-webpack-plugin");
</span><span> const { CleanWebpackPlugin } = require("clean-webpack-plugin");
</span><span> 
</span><span style=color:#c2d94c>+const isProd = process.env.NODE_ENV === "production";
</span><span style=color:#c2d94c>+
</span><span> module.exports = {
</span><span>   context: __dirname,
</span><span style=color:#f07178>-  mode: "development",
</span><span style=color:#c2d94c>+  mode: isProd ? "production" : "development",
</span><span>   entry: {
</span><span>     app: "./src/index.tsx"
</span><span>   },
</span></code></pre><p>Just changing the mode will get us a minified output: you can check it by running <code>build:prod</code> yourself.<p>Looking at the minified code, we can see that the sourcemap is embedded in the file still. The <a href=https://webpack.js.org/configuration/devtool/#production>best option for production environments</a> is <code>source-map</code> which we can set conditionally on the <code>isProd</code> variable: <code>devtool: isProd ? "source-map" : "eval-source-map",</code>. Running <code>build:prod</code> again will now properly create a separate file ending in <code>.js.map</code>. Remember that the sourcemap files should not be accessible by anyone other than you and your bug reporting app.<p>Lastly, the HMR from Webpack is injecting some code in the bundle that we do not want in our production bundle. We can disable it easily:<pre class=language-diff data-lang=diff style=background:#0f1419;color:#bfbab0><code class=language-diff data-lang=diff><span>diff --git a/webpack.config.js b/webpack.config.js
</span><span>index af5fd2f..63272fd 100644
</span><span style=color:#c594c5>--- a/webpack.config.js
</span><span style=color:#c594c5>+++ b/webpack.config.js
</span><span style=color:#c594c5>@@ -58,6 +58,6 @@ </span><span style=color:#59c2ff>module.exports = {
</span><span>       async: false
</span><span>     }),
</span><span>     new CleanWebpackPlugin(),
</span><span style=color:#f07178>-    new webpack.HotModuleReplacementPlugin()
</span><span style=color:#f07178>-  ]
</span><span style=color:#c2d94c>+    isProd ? false : new webpack.HotModuleReplacementPlugin()
</span><span style=color:#c2d94c>+  ].filter(Boolean)
</span><span> };
</span></code></pre><p>The commit is <a href=https://github.com/Keats/webpack-react-typescript/commit/4527184f2d7a49447451774b1bf5cc8d4cb3c1e5>https://github.com/Keats/webpack-react-typescript/commit/4527184f2d7a49447451774b1bf5cc8d4cb3c1e5</a>.<h2 id=splitting-chunks>Splitting chunks</h2><p>In our current situation, we generate a single file for the whole app: it clocks in at 132KB before gzip. This means that every time someone changes anything in the codebase, the full bundle will be invalidated and re-downloaded by every users.<p>There are two approaches to splitting the chunks:<ol><li><strong>bundle splitting</strong>: separating into fixed bundles, for example putting dependencies into another bundle<li><strong>code splitting</strong>: splitting your own code into multiple bundles loaded on demand</ol><h3 id=bundle-splitting>Bundle splitting</h3><p>The easiest bundle splitting strategy is to create a <code>vendors</code> bundle containing all dependencies. In our case we currently only have <code>react</code> and <code>react-dom</code> but it will inevitably grow and, unless you are upgrading dependencies every day, will not change very often. Dividing the bundle does not change anything for first-time users as they will have to download all files but repeat users will only download the bundles that changed.<p>Webpack comes with a built-in option to split everything coming from the <code>node_modules</code> folder to another bundle: <a href=https://webpack.js.org/plugins/split-chunks-plugin/#splitchunkschunks>optimization.splitChunks.chunks</a>. Setting it to <code>"all"</code> will produce a new JavaScript file with a name starting by <code>vendors~app</code> in the output directory weighting 131KB while the app bundle shrank down to 1.9KB. If you run <code>build:prod</code> again after making a change to <code>index.tsx</code>, you will notice the hash did change: we need to ensure the hash is done on the content rather than the build. In practice this means changing <code>[hash]</code> to <code>[contenthash]</code> in the <code>output.filename</code> configuration in production. Trying it again will now give the expected results: a change in our application code doesn't change the <code>vendors</code> bundle.<p>For many apps, just splitting the bundle that way will be enough to get started. If needed, you can create different kind of strategies, for example:<ul><li>one file per <code>npm</code> dependency<li>group packages per update of frequency: put the ones that change often in the same bundle<li>group packages per kind: all React packages could go in one bundle, all data viz in another etc<li>have multiple entry points: Webpack will create one file per entry point</ul><p>The <a href=https://webpack.js.org/plugins/split-chunks-plugin/#splitchunkscachegroups>Webpack documentation</a> has some examples demonstrating how to implement some of the strategies. Once again, start with the default dumb splitting and experiment as you go when needed.<p>The commit is <a href=https://github.com/Keats/webpack-react-typescript/commit/cd2669b62d9542794fdc52e6e6fb1702716ddc36>https://github.com/Keats/webpack-react-typescript/commit/cd2669b62d9542794fdc52e6e6fb1702716ddc36</a>.<h3 id=code-splitting>Code splitting</h3><p>Code splitting is allowing you to import some code on demand. It relies on the <a href=https://github.com/tc39/proposal-dynamic-import>dynamic import() proposal</a> which is now on stage 4, eg finished. A simple React example would be:<pre class=language-tsx data-lang=tsx style=background:#0f1419;color:#bfbab0><code class=language-tsx data-lang=tsx><span style=color:#ff7733>import </span><span>React </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"react"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#ff7733>class </span><span style=color:#59c2ff>LocationForm </span><span style=color:#ff7733>extends </span><span style=color:#59c2ff>React</span><span style=color:#f29668>.</span><span style=text-decoration:underline;color:#59c2ff>Component</span><span><{}> {
</span><span>   </span><span style=color:#ffb454>handleClickOnMap </span><span style=color:#f29668>= </span><span>() </span><span style=color:#ff7733>=> </span><span>{
</span><span>     </span><span style=color:#f29668>import</span><span>(</span><span style=color:#c2d94c>'./locationModal'</span><span>)
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>then</span><span>(({ </span><span style=color:#f29718>locationModal </span><span>}) </span><span style=color:#ff7733>=> </span><span>{
</span><span>        </span><span style=font-style:italic;color:#5c6773>// Use locationModal
</span><span>      })
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>catch</span><span>(</span><span style=color:#f29718>err </span><span style=color:#ff7733>=> </span><span>{
</span><span>        </span><span style=font-style:italic;color:#5c6773>// Handle failure
</span><span>      })</span><span style=color:#bfbab0cc>;
</span><span>   }
</span><span>
</span><span>   </span><span style=color:#ffb454>render</span><span>() {
</span><span>     </span><span style=color:#ff7733>return </span><span>(
</span><span>       </span><span style=color:#39bae690><</span><span style=color:#59c2ff>form</span><span style=color:#39bae690>>
</span><span>         </span><span style=color:#39bae690><</span><span style=color:#59c2ff>button </span><span style=color:#ffb454>onClick</span><span style=color:#f29668>=</span><span>{</span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>handleClickOnMap}</span><span style=color:#39bae690>></span><span>Select location</span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>button</span><span style=color:#39bae690>>
</span><span>       </span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>form</span><span style=color:#39bae690>>
</span><span>     )</span><span style=color:#bfbab0cc>;
</span><span>   }
</span><span>}
</span></code></pre><p>Imagine that the <code>locationModal</code> component is loading <a href=https://leafletjs.com/>Leaflet</a> and that this is the only place where it is used. With the bundle splitting, Leaflet would be in your bundle even for users never seeing that form. If you are doing code splitting, you will obviously need to make sure Leaflet is not part of another chunk. Another obvious contender for code splitting is data visualisation: plottting libraries are typically heavy and if you only have them in one page you can split it from your bundle to provide a faster experience for everyone.<p>Code splitting is very powerful but not that useful if you are just starting: worry about it when your codebase is bigger. If you are using React, the <a href=https://reactjs.org/docs/code-splitting.html>documentation page on code splitting</a> is very well written and should answer most questions on how to actually use it.<p>To use code splitting with TypeScript, you will also need to change <code>module</code> in <code>tsconfig.json</code> to <code>esnext</code>.<h3 id=analyzing-bundles>Analyzing bundles</h3><p>Once you have your bundle(s), a useful step is to actually check what they contain and whether there is fat that can be trimmed. <a href=https://www.npmjs.com/package/webpack-bundle-analyzer>webpack-bundle-analyzer</a> is shining for that usecase.<pre class=language-bash data-lang=bash style=background:#0f1419;color:#bfbab0><code class=language-bash data-lang=bash><span style=color:#ffb454>$</span><span> yarn add webpack-bundle-analyzer</span><span style=color:#f29718> --dev
</span></code></pre><p>We only need to analyze bundles once in a while so I like to create a new script for it <code>"analyze": "cross-env NODE_ENV=production ANALYZE=true webpack",</code> and only instantiate the plugin when that <code>ANALYZE</code> environment variable is set to <code>true</code>. Running <code>analyze</code> will give you a treemap visualisation of each package used and their size, with and without gzip.<p>Using this tool, it becomes very easy to notice some packages taking way more spaces than they should. The most classic examples I've seen personally are not removing <a href=https://momentjs.com/>Momentjs</a> locales for an English only site and having the full <a href=https://lodash.com/>Lodash</a> while only using one or two functions.<p>The commit is <a href=https://github.com/Keats/webpack-react-typescript/commit/41190ae6e279c84c8614d5d77656b8afaed1dea3>https://github.com/Keats/webpack-react-typescript/commit/41190ae6e279c84c8614d5d77656b8afaed1dea3</a>.<h2 id=extracting-css>Extracting CSS</h2><p>If you added Sass by following the previous article and looked at the bundle analyzer results, you might have noticed that the app bundle contains CSS. That's because we've inlined them in our configuration via <code>style-loader</code> and need to extract it to a separate CSS file in production environment instead using a plugin.<pre class=language-bash data-lang=bash style=background:#0f1419;color:#bfbab0><code class=language-bash data-lang=bash><span style=color:#ffb454>$</span><span> yarn add mini-css-extract-plugin</span><span style=color:#f29718> --dev
</span></code></pre><p>The change is pretty straightforward: we load the <code>MiniCssExtractPlugin</code> loader instead of <code>style-loader</code> in production and add the plugin to the plugin list. The plugin can be set for every environment as it will not do anything unless the loader is also used.<p>Running <code>build:prod</code> will now create a CSS file as well as a sourcemap in the <code>dist</code> folder. I'm not 100% sure the sourcemap is accurate as I have never used them for CSS.<p>The commit is <a href=https://github.com/Keats/webpack-react-typescript/commit/e97a368d67e88f2c1adb9b018b8a4164fdfd3283>https://github.com/Keats/webpack-react-typescript/commit/e97a368d67e88f2c1adb9b018b8a4164fdfd3283</a>.<h2 id=conclusion>Conclusion</h2><p>If you followed the articles or just cloned the repository, you should be in a good place to start actually building your project. It might look complicated compared to <a href=https://github.com/facebook/create-react-app>create-react-app</a> but this is a minimal setup that you understand and that only has things what you need. Well, being a JavaScript project it still pulls way too many dependencies just for that but it's a good start.</section></article></main></div>