<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Using Protobuf instead of JSON to communicate with a frontend
        
    </title><meta content="Using Protobuf instead of JSON to communicate with a frontend" property=og:title><meta content="Using Protobuf instead of JSON to communicate with a frontend" property=og:description><meta content="Using Protobuf instead of JSON to communicate with a frontend" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://ashang.github.io/zz/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ashang.github.io/zz/atom.xml rel=alternate title=atbb type=application/atom+xml><link href=https://ashang.github.io/zz/theme/light.css rel=stylesheet><link href=https://ashang.github.io/zz/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://ashang.github.io/zz/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ashang.github.io/zz/>atbb</a><div class=socials><a class=social href=https://github.com/ashang/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=$BASE_URL/search/ style=margin-left:.7em>Search</a><a href=/notes style=margin-left:.7em>/notes</a><a href=/posts style=margin-left:.7em>/posts</a><a href=/gallery style=margin-left:.7em>/gallery</a><a href=/tags style=margin-left:.7em>/tags</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://ashang.github.io/zz/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Using Protobuf instead of JSON to communicate with a frontend<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2015-06-14</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://ashang.github.io/zz/posts/trying-to-replace-json-with-protobuf/#what-is-protobuf>What is Protobuf</a><li><a href=https://ashang.github.io/zz/posts/trying-to-replace-json-with-protobuf/#example-app>Example app</a> <ul><li><a href=https://ashang.github.io/zz/posts/trying-to-replace-json-with-protobuf/#server-side>Server-side</a><li><a href=https://ashang.github.io/zz/posts/trying-to-replace-json-with-protobuf/#client-side>Client-side</a></ul><li><a href=https://ashang.github.io/zz/posts/trying-to-replace-json-with-protobuf/#conclusion>Conclusion</a></ul><section class=body><p>Protocol buffers or other binary serialization formats like Thrift are widely used to communicate between services.<h2 id=what-is-protobuf>What is Protobuf</h2><p><a href=https://developers.google.com/protocol-buffers/docs/overview>Protobuf</a> is a binary serialization format from Google meant to serialize structured data. It has librairies in most languages, including Python and Javascript.<p>Tools like Protobuf have a few advantages over JSON:<ul><li>smaller in size<li>typed<li>offer a common interface for all your services, you can just update your .proto or .thrift and share those with the services using it, as long as there is a library for that language</ul><p><a href=https://thrift.apache.org/>Thrift</a> does more as it also allows you to define methods as well as structs.<h2 id=example-app>Example app</h2><p>As an example we are going to make a small address book app. Coincidentally that's the example that the Python Protobuf documention is using as well but that wasn't on purpose, I swear! The data is generated randomly on startup of the flask app. The repo is in our <a href=https://github.com/WeAreWizards/protojson>github</a> if you want to try it yourself. As mentioned in the README, the Python library for Protobuf does not support Python 3 (yet) so you will have to make a Python 2 virtualenv if you decide to install the server. The server will deliver the content in JSON or Protobuf based on the <code>Accept</code> header.<h3 id=server-side>Server-side</h3><p>First we need to define our Protobuf schema, which is done in the <a href=https://github.com/WeAreWizards/protojson/blob/master/addressbook.proto>addressbook.proto</a> file. Here is one of the model as example:<pre class=language-json data-lang=json style=background:#0f1419;color:#bfbab0><code class=language-json data-lang=json><span>message Contact {
</span><span>  </span><span style=color:#ff3333>required string first_name = 1;
</span><span>  </span><span style=color:#ff3333>required string last_name = 2;
</span><span>  </span><span style=color:#ff3333>optional Address address = 3;
</span><span>  </span><span style=color:#ff3333>repeated Phone phone_numbers = 4;
</span><span>};
</span></code></pre><p>In this model, <code>first_name</code> and <code>last_name</code> are required (controversial, I'll come back to that later), the address model is optional and we can have 0, 1 or n <code>phone_numbers</code>. Now, Python doesn't know about .proto files so we need to use the <a href=https://pypi.python.org/pypi/protobuf>Python library</a> to generate code that we can use. This is the <a href=https://github.com/WeAreWizards/protojson/blob/master/addressbook_pb2.py>addressbook_pb2.py</a> file. You can then import that in your Python code and access the models defined in your .proto file. Have a look at the <a href=https://github.com/WeAreWizards/protojson/blob/master/data.py>data.py</a> file to see an example. You can use those models as you would with a class and using kwargs for every attributes. You also need to serialize them before sending, using the <code>SerializeToString()</code> method in our app.<h3 id=client-side>Client-side</h3><p>The client is written in Angular purely as an example and because ng-repeat was exactly what I wanted here. The code is a quick prototype so don't expect it to be idiomatic. It uses <a href=https://github.com/dcodeIO/ProtoBuf.js>ProtoBuf.js</a> as a Protobuf library. The first thing we do is a basic GET to get all our contacts which is trivial since you can just dump the response data into our scope variable. On the other hand, we need to handle Protobuf deserialization since looking at our network tab we receive binary data looking like:<pre class=language-json data-lang=json style=background:#0f1419;color:#bfbab0><code class=language-json data-lang=json><span>.
</span><span>�Marlon��Sheets��
</span><span>�</span><span style=color:#f29718>7771</span><span> Eastern Avenue��</span><span style=color:#f29718>11239
</span><span>,
</span><span>�Harley��Malloy����</span><span style=color:#f29718>60139</span><span style=color:#c2d94c>"����
</span><span>(</span><span style=color:#f29718>712</span><span>)</span><span style=color:#f29718>614-9303
</span><span>Y
</span><span>�Mack�  Hendricks�</span><span style=color:#f29718>3
</span><span>�</span><span style=color:#f29718>9573</span><span> Kimridge Cove
</span><span>�</span><span style=color:#f29718>7490</span><span> Orchard Hill Cove��</span><span style=color:#f29718>11239</span><span style=color:#c2d94c>"����
</span><span>(</span><span style=color:#f29718>802</span><span>)</span><span style=color:#f29718>466-7004
</span><span>�
</span><span>�Madeline��Bowen����</span><span style=color:#f29718>87023
</span><span style=color:#f29718>0
</span><span>�Willa��Sadler��
</span><span>�</span><span style=color:#f29718>693</span><span> Burlington Parkway��</span><span style=color:#f29718>43824
</span><span>T
</span></code></pre><p>(Note that I had to replace some of the characters so the RSS could be generated). By default, this is more compact than JSON by quite a bit but once I turned on GZIP, the difference became much smaller: 851B for ProtoBuf and 942B for JSON.<p>In the example I copied the .proto file into the static directory and created our <a href=https://github.com/WeAreWizards/protojson/blob/master/static/main.js#L12-L15>models</a> following the ProtoBuf.js tutorial. Now the only two things left to do for our GET is to add a <code>responseType: 'arraybuffer'</code> in our HTTP requests (which would be done in the config for a proper angular app) and decode the data we receive using <code>MyModel.decode(data)</code>. Creating an instance looks like a class in JavaScript as well:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ff7733>var </span><span>contact </span><span style=color:#f29668>= new </span><span style=color:#59c2ff>Contact</span><span>({
</span><span>  first_name</span><span style=color:#bfbab0cc>: </span><span>_contact[</span><span style=color:#c2d94c>'firstName'</span><span>]</span><span style=color:#bfbab0cc>,
</span><span>  last_name</span><span style=color:#bfbab0cc>: </span><span>_contact[</span><span style=color:#c2d94c>'lastName'</span><span>]</span><span style=color:#bfbab0cc>,
</span><span>})</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Note that supplying an incorrect parameter such as an unknown field will result in a runtime error.<p>POSTing is a bit more complex as Angular tries to be too clever and forces us to do some changes in the HTTP request:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=font-style:italic;color:#5c6773>// The transformRequest is needed
</span><span style=color:#ff7733>var </span><span>req </span><span style=color:#f29668>= </span><span>{
</span><span>  method</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>'POST'</span><span style=color:#bfbab0cc>,
</span><span>  url</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>'/api/contacts'</span><span style=color:#bfbab0cc>,
</span><span>  responseType</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>'arraybuffer'</span><span style=color:#bfbab0cc>,
</span><span>  </span><span style=color:#ffb454>transformRequest</span><span style=color:#bfbab0cc>: </span><span style=color:#ff7733>function</span><span>(</span><span style=color:#f29718>r</span><span>) { </span><span style=color:#ff7733>return </span><span>r</span><span style=color:#bfbab0cc>;</span><span>}</span><span style=color:#bfbab0cc>,
</span><span>  data</span><span style=color:#bfbab0cc>: </span><span>contact</span><span style=color:#f29668>.</span><span style=color:#ffb454>toArrayBuffer</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>  headers</span><span style=color:#bfbab0cc>: </span><span>{
</span><span>    </span><span style=color:#c2d94c>'Content-Type'</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>'binary/octet-stream'
</span><span>  }
</span><span>}</span><span style=color:#bfbab0cc>;
</span></code></pre><h2 id=conclusion>Conclusion</h2><p>While I see the need for Protobuf and Thrift for services communication, I don't really see the point of using it instead of JSON for the frontend. First, the network tab becomes pretty much unusable and I use it very often. Since Protobuf doesn't use setters, you can use wrong types in your object and it will only throw an error much later, but earlier than with vanilla JavaScript. Using <a href=http://www.typescriptlang.org/>Typescript</a> or <a href=http://flowtype.org/>Flow</a> with good definitions would solve many issues at compile time. Another point I raised earlier is that Google recommends to mark every field as optional in Protobuf, which is better in terms of compatibility but means you can send incomplete data. Has any of you used a binary serialization for that successfully? Let us know in the comments or send us a tweet <a href=https://twitter.com/WeAreWizardsIO>@WeAreWizardsIO</a>.</section></article></main></div>