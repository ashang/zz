<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Migrating to gulp 4
        
    </title><meta content="Migrating to gulp 4" property=og:title><meta content="Migrating my ng-boilerplate to gulp4" property=og:description><meta content="Migrating my ng-boilerplate to gulp4" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://ashang.github.io/zz/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ashang.github.io/zz/atom.xml rel=alternate title=atbb type=application/atom+xml><link href=https://ashang.github.io/zz/theme/light.css rel=stylesheet><link href=https://ashang.github.io/zz/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://ashang.github.io/zz/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ashang.github.io/zz/>atbb</a><div class=socials><a class=social href=https://github.com/ashang/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=$BASE_URL/search/ style=margin-left:.7em>Search</a><a href=/notes style=margin-left:.7em>/notes</a><a href=/posts style=margin-left:.7em>/posts</a><a href=/gallery style=margin-left:.7em>/gallery</a><a href=/tags style=margin-left:.7em>/tags</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://ashang.github.io/zz/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Migrating to gulp 4<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2015-03-20</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#updating-dependencies>Updating dependencies</a><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#migrating-the-gulpfile>Migrating the gulpfile</a> <ul><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#calling-gulp>Calling gulp</a><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#fixing-the-errors-we-re-getting>Fixing the errors we're getting</a><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#small-cleanup>Small cleanup</a></ul><li><a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/#wrap-up>Wrap up</a></ul><section class=body><p>Last year I wrote a blog post on my personal website (you can see it here <a href=https://ashang.github.io/zz/posts/migrating-to-gulp4/2014-02-17_introducing-people-to-gulp.md>Gulp by example </a>) showing what <a href=http://gulpjs.com/>gulp</a> was and making a demo project using it. Since then, the team behind it did a lot of work on v4 of gulp which, while not released as of the writing of the post, is stable enough to be used.<p>Rather than going through a list of new features, let's update my <a href=https://github.com/Keats/ng-boilerplate>angular boilerplate</a> to use gulp4.<p>You can have a look at the <a href=https://github.com/Keats/ng-boilerplate#user-content-goal>Goal section of the README</a> to know what this boilerplate does but for those not wanting to open the link: Typescript, Sass, automatic DI, template preloading, testing with Karma and Protractor, live reload with browser-sync.<blockquote><p>Note: I'm not using this boilerplate personally anymore since I don't really do vanilla angular anymore.</blockquote><p>Here's the <a href=https://github.com/Keats/ng-boilerplate/tree/87e75551651e94dfc1aa6135e1ea7cb5bd61cf0f>starting commit</a>.<h2 id=updating-dependencies>Updating dependencies</h2><p>Nothing fancy here, just updating our npm and bower dependencies, including pointing to the gulp4 branch on github. To use npm install from a github repo, you can use:<pre class=language-bash data-lang=bash style=background:#0f1419;color:#bfbab0><code class=language-bash data-lang=bash><span style=color:#ffb454>$</span><span> npm install</span><span style=color:#f29718> --save-dev</span><span> gulpjs/gulp.git#4.0
</span></code></pre><p>The boilerplate demo tests are going to fail at that point because of changes in the api of gulp and probably some in other libraries we just updated as well.<p>You can see the commit <a href=https://github.com/Keats/ng-boilerplate/commit/49a339cc5cbde8f5374b8f4c915a548dc2916cc4>here</a>.<h2 id=migrating-the-gulpfile>Migrating the gulpfile</h2><h3 id=calling-gulp>Calling gulp</h3><p>The first thing we need to do is ensure that we are using the right version of gulp. You might have another version installed globally or nothing installed globally like me. The easiest way (at least to me) to deal with that issue is the <a href=https://docs.npmjs.com/misc/scripts>npm scripts</a> part of the package.json.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=font-style:italic;color:#5c6773>// package.json
</span><span style=color:#c2d94c>"scripts"</span><span>: {
</span><span>  </span><span style=color:#c2d94c>"gulp"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"./node_modules/gulp/bin/gulp.js"
</span><span>}</span><span style=color:#bfbab0cc>,
</span><span>
</span><span style=font-style:italic;color:#5c6773>// in your terminal, instead of using gulp, use npm run gulp
</span><span>npm run gulp
</span></code></pre><p>The downside is that you will get npm errors instead of the regular ones but that's only an issue when building your gulpfile. Let's not forget to update the travis.yml to use that npm script too.<p>You can see the commit <a href=https://github.com/Keats/ng-boilerplate/commit/ef30315f43580e8b3c1ba85d4536c7fe0d69365d>here</a>.<h3 id=fixing-the-errors-we-re-getting>Fixing the errors we're getting</h3><p>If you run the gulpfile locally or look at the <a href=https://travis-ci.org/Keats/ng-boilerplate/builds/54252789>travis build</a>, you will notice we get the following error:<pre class=language-bash data-lang=bash style=background:#0f1419;color:#bfbab0><code class=language-bash data-lang=bash><span style=color:#ffb454>assert.js:87
</span><span>  </span><span style=color:#ffb454>throw</span><span> new assert.AssertionError({
</span><span>        ^
</span><span>AssertionError: Task function must be specified
</span><span>    at Gulp.set (/home/vincent/Code/ng-boilerplate/node_modules/gulp/node_modules/undertaker/lib/set.js:14:3)
</span><span>    at Gulp.task (/home/vincent/Code/ng-boilerplate/node_modules/gulp/node_modules/undertaker/lib/task.js:14:8)
</span><span>....
</span></code></pre><p>This comes from the fact that gulp.task changed and the 3 parameters signature was removed. In short, tasks that look like the one below will need to be changed to remove the <code>[]</code> parameter:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span>gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>task</span><span>(</span><span style=color:#c2d94c>'default'</span><span style=color:#bfbab0cc>, </span><span>[</span><span style=color:#c2d94c>'build'</span><span>]</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>function </span><span>() {
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#ffb454>runSequence</span><span>([</span><span style=color:#c2d94c>'watch'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'karma-watch'</span><span>])</span><span style=color:#bfbab0cc>;
</span><span>})</span><span style=color:#bfbab0cc>;
</span></code></pre><p>To give a quick background to people not familiar with gulp, the list parameter is a list of tasks that need to be run before running that task. In this case it will call the build task before running watch and karma-watch in order (runSequence is another thing that can be changed but we will get back to that later). To solve that very common issue of task dependencies, two methods were added:<ul><li><code>gulp.series</code>: will run the tasks in order<li><code>gulp.parallel</code>: will run the tasks in parallel</ul><p>Let's fix our error by replacing those dependent tasks, for example for the default task:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span>gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>task</span><span>(
</span><span>  </span><span style=color:#c2d94c>'default'</span><span style=color:#bfbab0cc>,
</span><span>  gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>series</span><span>(</span><span style=color:#c2d94c>'build'</span><span style=color:#bfbab0cc>, </span><span>gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>parallel</span><span>(</span><span style=color:#c2d94c>'browser-sync'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'watch'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'karma-watch'</span><span>))
</span><span>)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>In that case we first want to run build, and then browser-sync, watch and karma-watch in parallel. If you look at the commit below, you will be able to spot an easy mistake: browser-sync is in the <code>gulp.series</code> despite being blocking. In short, don't put blocking tasks in a series.<p>Now trying to run the build task, I get another error:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span>[</span><span style=color:#f29718>15</span><span>:</span><span style=color:#f29718>09</span><span>:</span><span style=color:#f29718>07</span><span>] </span><span style=color:#59c2ff>TypeError</span><span style=color:#bfbab0cc>: </span><span style=color:#f29718>undefined </span><span>is not a </span><span style=color:#ff7733>function
</span><span>    </span><span style=color:#ffb454>at</span><span> /</span><span style=color:#ffb454>home</span><span>/</span><span style=color:#ffb454>vincent</span><span>/</span><span style=color:#ffb454>Code</span><span>/</span><span style=color:#ffb454>ng</span><span>-</span><span style=color:#ffb454>boilerplate</span><span>/</span><span style=color:#ffb454>node_modules</span><span>/</span><span style=color:#ffb454>run</span><span>-</span><span style=color:#ffb454>sequence</span><span>/</span><span style=color:#ffb454>index</span><span>.</span><span style=color:#ffb454>js</span><span>:18:22
</span><span>    </span><span style=color:#ffb454>at Array</span><span>.</span><span style=color:#ffb454>forEach </span><span>(</span><span style=color:#f29718>native</span><span>)
</span><span>    </span><span style=color:#ffb454>at verifyTaskSets </span><span>(/</span><span style=color:#f29718>home</span><span>/</span><span style=color:#f29718>vincent</span><span>/</span><span style=color:#f29718>Code</span><span>/</span><span style=color:#f29718>ng</span><span>-</span><span style=color:#f29718>boilerplate</span><span>/</span><span style=color:#f29718>node_modules</span><span>/</span><span style=color:#f29718>run</span><span>-</span><span style=color:#f29718>sequence</span><span>/index.js</span><span style=color:#f29668>:</span><span style=color:#f29718>12</span><span style=color:#f29668>:</span><span style=color:#f29718>11</span><span>)
</span></code></pre><p>Since gulp 4 has a method to run things sequentially, let's use it.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=font-style:italic;color:#5c6773>// before
</span><span>gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>task</span><span>(</span><span style=color:#c2d94c>'build'</span><span style=color:#bfbab0cc>, </span><span style=color:#ff7733>function</span><span>(){
</span><span>  </span><span style=color:#ff7733>return </span><span style=color:#ffb454>runSequence</span><span>(
</span><span>    </span><span style=color:#c2d94c>'clean'</span><span style=color:#bfbab0cc>,
</span><span>    [</span><span style=color:#c2d94c>'sass'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'copy-assets'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'ts-compile'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'templates'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'copy-vendor'</span><span>]</span><span style=color:#bfbab0cc>,
</span><span>    </span><span style=color:#c2d94c>'index'
</span><span>  )</span><span style=color:#bfbab0cc>;
</span><span>)};
</span><span>
</span><span style=font-style:italic;color:#5c6773>// after
</span><span>gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>task</span><span>(
</span><span>  </span><span style=color:#c2d94c>'build'</span><span style=color:#bfbab0cc>,
</span><span>  gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>series</span><span>(
</span><span>    </span><span style=color:#c2d94c>'clean'</span><span style=color:#bfbab0cc>,
</span><span>    gulp</span><span style=color:#f29668>.</span><span style=color:#ffb454>parallel</span><span>(</span><span style=color:#c2d94c>'sass'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'copy-assets'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'ts-compile'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'templates'</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'copy-vendor'</span><span>)</span><span style=color:#bfbab0cc>,
</span><span>    </span><span style=color:#c2d94c>'index'
</span><span>  )
</span><span>);
</span></code></pre><blockquote><p>Note: I had to modify some tasks like the browser-sync since its API changed. I also had to make a <a href=https://github.com/dlmanning/gulp-sass/pull/207>patch</a> to gulp-sass to update the node-sass version.</blockquote><p>You can see the commit <a href=https://github.com/Keats/ng-boilerplate/commit/91a05401c6ea532467bc00b5a6e54fd95b6b0eaf>here</a>.<p>Looking at the <a href=https://travis-ci.org/Keats/ng-boilerplate/builds/54274589>build</a>, it still fails because of a missing selenium jar which means a protractor error. My elegant solution was the <a href=https://github.com/Keats/ng-boilerplate/commit/d999db2442ac72fc440e8ff9cccd8348c533c72d>following</a>, as in removing protractor from travis because I'm not using it right now anyway.<h3 id=small-cleanup>Small cleanup</h3><p>The following is not strictly related to gulp4 but contains some of the things I like to do to have a clean gulpfile. The config part at the top of the gulpfile (where I am defining all the paths to inject) is quite ugly but I am not going to touch it here, only change the gulp related things.<p>First thing, <a href=https://www.npmjs.com/package/gulp-load-plugins>gulp-load-plugins</a> makes things quite simple but the prefix I had chosen, 'plugins', is quite verbose and takes up space. Recently I've started using <code>$</code> which works quite well. Something that took me way too long to realise is that it auto-camelCases packages names with dash so my following line was useless:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span>plugins</span><span style=color:#f29668>.</span><span>ngAnnotate </span><span style=color:#f29668>= </span><span style=color:#f07178>require</span><span>(</span><span style=color:#c2d94c>'gulp-ng-annotate'</span><span>)</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Another thing to examine is whether some of the gulp plugins you're using actually bring any values compared to using the actual npm module directly. In my boilerplate, gulp-karma is not doing anything special and was only necessary while the karma team was fixing some of the issues the plugin was solving.<p>While going through the file, I also realised I didn't test the watch process at all and that it didn't work (surprising eh).<p>The fix was easy and I included it in the <a href=https://github.com/Keats/ng-boilerplate/commit/bee9fba6e9ee2602e96c8d735d409b31a267d655>clean up commit</a>.<p>Lastly, I have seen quite a few people dividing their tasks in individual files but that seems like an excessive measure to me. Maybe it makes more sense if you have very long files but all of mine are between 50 and 200 lines (this one is actually my longest) so I never felt the need.<h2 id=wrap-up>Wrap up</h2><p>Some functions from gulp 3 such a <code>gulp.start</code> and <code>gulp.run</code> were deprecated and are not covered in this article since I never used them in any of my gulpfiles.<p>There is also a bunch of new functions that I haven't used yet. To have a complete overview of what's new, you can check the <a href=https://github.com/gulpjs/gulp/blob/master/CHANGELOG.md#user-content-400>gulp 4 changelog</a>. Gulp 4 is still in alpha so I'll update this article if any breaking change happens.<p>A question often asked is why use gulp when you have things like <a href=http://webpack.github.io/>webpack</a> around but that's out of scope for this article but will probably be part of another one.</section></article></main></div>