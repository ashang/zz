<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         Testing Django projects
        
    </title><meta content="Testing Django projects" property=og:title><meta content="Tools and tricks I use to make tests fast and easy to write in Django projects" property=og:description><meta content="Tools and tricks I use to make tests fast and easy to write in Django projects" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://ashang.github.io/zz/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ashang.github.io/zz/atom.xml rel=alternate title=atbb type=application/atom+xml><link href=https://ashang.github.io/zz/theme/light.css rel=stylesheet><link href=https://ashang.github.io/zz/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://ashang.github.io/zz/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ashang.github.io/zz/>atbb</a><div class=socials><a class=social href=https://github.com/ashang/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=$BASE_URL/search/ style=margin-left:.7em>Search</a><a href=/notes style=margin-left:.7em>/notes</a><a href=/posts style=margin-left:.7em>/posts</a><a href=/gallery style=margin-left:.7em>/gallery</a><a href=/tags style=margin-left:.7em>/tags</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://ashang.github.io/zz/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Testing Django projects<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2013-09-02</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#introduction>Introduction</a><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#basics>Basics</a> <ul><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#structure>Structure</a><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#tools>Tools</a><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#tips-for-having-and-keeping-fast-tests>Tips for having (and keeping) fast tests</a></ul><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#testing>Testing</a> <ul><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#a-form-model>A form/model</a><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#a-view>A view</a><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#mocking>Mocking</a></ul><li><a href=https://ashang.github.io/zz/posts/testing-django-projects/#conclusion>Conclusion</a></ul><section class=body><h2 id=introduction>Introduction</h2><p>This post will introduce what I consider the best practices when testing a Django project. As you've probably read 1000 times, testing is very important because without them, deploying is pretty much a gamble on whether something is going to break or not. There are a few different type of tests:<ul><li>unit tests: test a specific function, one path at a time (by path I mean if/else conditions)<li>integration tests: test a whole user action, from the template to the model</ul><p>What I do is unit tests all the functions I write (except the views) and integration tests for the views. This ensures you got everything covered.<p>Whether you write the tests before the code (if you're doing TDD) or after is up to you. I like doing TDD for 'easy' code when I know how I am going to do it but otherwise I first write a quick draft that works, then code it again the TDD way. I found that it results in better code using that process but again it's up to you.<h2 id=basics>Basics</h2><h3 id=structure>Structure</h3><p>I like putting all the tests in a top level package (ie at the same level as the apps) because I find it easier to navigate. Make sure you have one test file for models, views, forms, etc rather than putting it in a single file like the default django does because it quickly becomes impossible to work with.<h3 id=tools>Tools</h3><p>Lots of packages exist to make testing easier. Here are the ones I use :<ul><li><a title="factory boy" href=http://factoryboy.readthedocs.org/en/latest/>factory boy</a>: create objects easily (no more fixtures)<li><a href=https://github.com/jezdez/django-discover-runner title=django-discover-runner>django-discover-runner</a>: enhancement of the django test runner (to allow putting tests wherever you want), it will become the default test runner starting 1.6<li><a href=http://mock.readthedocs.org/en/latest/ title=mock>mock</a>: mocking library, for when you don't really want to call some functions (usually external services), part of python standard library starting 3.3<li><a href=https://pypi.python.org/pypi/django-webtest title=django-webtest>django-webtest</a>: makes integration testing of views easier<li><a href=http://nedbatchelder.com/code/coverage/ title=coverage>coverage</a>: for when you want to know whether you're getting close to 100% coverage or not</ul><p>I also like to modify the manage.py to ensure I don't type to type the settings file to use, it looks like this :<pre class=language-python data-lang=python style=background:#0f1419;color:#bfbab0><code class=language-python data-lang=python><span style=font-style:italic;color:#5c6773>#!/usr/bin/env python
</span><span style=color:#ff7733>import </span><span>os
</span><span style=color:#ff7733>import </span><span>sys
</span><span>
</span><span style=color:#ff7733>if </span><span>__name__ </span><span style=color:#f29668>== </span><span style=color:#c2d94c>"__main__"</span><span>:
</span><span>
</span><span>    </span><span style=color:#ff7733>if </span><span>sys</span><span style=color:#f29668>.</span><span>argv[</span><span style=color:#f29718>1</span><span>] </span><span style=color:#f29668>== </span><span style=color:#c2d94c>'test'</span><span>:
</span><span>        os</span><span style=color:#f29668>.</span><span>environ</span><span style=color:#f29668>.</span><span style=color:#ffb454>setdefault</span><span>(</span><span style=color:#c2d94c>"DJANGO_SETTINGS_MODULE"</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"myproject.settings.test"</span><span>)
</span><span>    </span><span style=color:#ff7733>else</span><span>:
</span><span>        os</span><span style=color:#f29668>.</span><span>environ</span><span style=color:#f29668>.</span><span style=color:#ffb454>setdefault</span><span>(</span><span style=color:#c2d94c>"DJANGO_SETTINGS_MODULE"</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"myproject.settings.dev"</span><span>)
</span><span>
</span><span>    </span><span style=color:#ff7733>from </span><span>django</span><span style=color:#f29668>.</span><span>core</span><span style=color:#f29668>.</span><span>management </span><span style=color:#ff7733>import </span><span>execute_from_command_line
</span><span>
</span><span>    </span><span style=color:#ffb454>execute_from_command_line</span><span>(sys</span><span style=color:#f29668>.</span><span>argv)
</span></code></pre><h3 id=tips-for-having-and-keeping-fast-tests>Tips for having (and keeping) fast tests</h3><p>Nothing is worse than having a test suite slow you down when developing (especially if you're doing TDD). Here are a few of the settings I use to speed it up<pre class=language-python data-lang=python style=background:#0f1419;color:#bfbab0><code class=language-python data-lang=python><span style=font-style:italic;color:#5c6773># IN-MEMORY TEST DATABASE
</span><span style=font-style:italic;color:#5c6773># If you're not using DB specific features
</span><span>DATABASES </span><span style=color:#f29668>= </span><span>{
</span><span>    </span><span style=color:#c2d94c>"default"</span><span style=color:#bfbab0cc>: </span><span>{
</span><span>        </span><span style=color:#c2d94c>"ENGINE"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"django.db.backends.sqlite3"</span><span style=color:#bfbab0cc>,
</span><span>        </span><span style=color:#c2d94c>"NAME"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>":memory:"</span><span style=color:#bfbab0cc>,
</span><span>        </span><span style=color:#c2d94c>"USER"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>""</span><span style=color:#bfbab0cc>,
</span><span>        </span><span style=color:#c2d94c>"PASSWORD"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>""</span><span style=color:#bfbab0cc>,
</span><span>        </span><span style=color:#c2d94c>"HOST"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>""</span><span style=color:#bfbab0cc>,
</span><span>        </span><span style=color:#c2d94c>"PORT"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>""</span><span style=color:#bfbab0cc>,
</span><span>    }</span><span style=color:#bfbab0cc>,
</span><span>}
</span><span>
</span><span style=font-style:italic;color:#5c6773># FAST HASHING FOR PASSWORDS
</span><span>PASSWORD_HASHERS </span><span style=color:#f29668>= </span><span>(
</span><span>    </span><span style=color:#c2d94c>'django.contrib.auth.hashers.UnsaltedMD5PasswordHasher'</span><span style=color:#bfbab0cc>,
</span><span>)
</span><span>
</span><span style=font-style:italic;color:#5c6773># Use syncdb instead of migrate if you're using South
</span><span>SOUTH_TESTS_MIGRATE </span><span style=color:#f29668>= </span><span style=color:#f29718>False
</span></code></pre><p>Also, be careful when testing with saving objects : only do it if it's necessary (if you're using factory_boy, it means using MyFactory.build() instead MyFactory()).<h2 id=testing>Testing</h2><h3 id=a-form-model>A form/model</h3><p>I group these 2 as they are quite similar : basically if you're writing a method on one of those (be it a custom clean() on a form or a method on a method to deal with some business logic), it should have a test for each of the different 'paths' it contains. By path I mean every branch of code exists, which ideally range from 1 to 3 (more than that and it could mean that the method does too much). Those are unit tests, testing one thing at a time so if a test fails, there should only one possible reason.<h3 id=a-view>A view</h3><p>This is where webtest shines. Most of the tests I write are actually integration tests, testing thoroughly every path of each view. For example, for a FormView you will have 3 paths : first GET, success POST and POST with errors. By testing all of the branches you reduce the likelihood of unexpected exceptions (oxymoron I know, exceptions are rarely expected). Webtest allow you to easily login (no need for self.client.login(...) anymore), easily grab/submit forms and access the DOM.<p>Here's an example of testing a landing page with an email field from a model called Interest :<pre class=language-python data-lang=python style=background:#0f1419;color:#bfbab0><code class=language-python data-lang=python><span style=color:#ff7733>class </span><span style=color:#59c2ff>PublicViewsTests</span><span>(</span><span style=text-decoration:underline;color:#59c2ff>WebTest</span><span>):
</span><span>    </span><span style=color:#ff7733>def </span><span style=color:#ffb454>test_anonymous_can_access_landing_page</span><span>(</span><span style=color:#f29718>self</span><span>):
</span><span>        url </span><span style=color:#f29668>= </span><span style=color:#ffb454>reverse</span><span>(</span><span style=color:#c2d94c>'public:landing-page'</span><span>)
</span><span>        response </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>app</span><span style=color:#f29668>.</span><span style=color:#ffb454>get</span><span>(url)
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertEqual</span><span>(response</span><span style=color:#f29668>.</span><span>status_code</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>200</span><span>)
</span><span>
</span><span>    </span><span style=color:#ff7733>def </span><span style=color:#ffb454>test_anonymous_can_add_email</span><span>(</span><span style=color:#f29718>self</span><span>):
</span><span>        url </span><span style=color:#f29668>= </span><span style=color:#ffb454>reverse</span><span>(</span><span style=color:#c2d94c>'public:landing-page'</span><span>)
</span><span>        form </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>app</span><span style=color:#f29668>.</span><span style=color:#ffb454>get</span><span>(url)</span><span style=color:#f29668>.</span><span>form
</span><span>        form[</span><span style=color:#c2d94c>'email'</span><span>] </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'easy@abc.com'
</span><span>        form</span><span style=color:#f29668>.</span><span style=color:#ffb454>submit</span><span>()
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertEqual</span><span>(Interest</span><span style=color:#f29668>.</span><span>objects</span><span style=color:#f29668>.</span><span style=color:#ffb454>count</span><span>()</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>1</span><span>)
</span><span>
</span><span>    </span><span style=color:#ff7733>def </span><span style=color:#ffb454>test_invalid_interest_email_error</span><span>(</span><span style=color:#f29718>self</span><span>):
</span><span>        url </span><span style=color:#f29668>= </span><span style=color:#ffb454>reverse</span><span>(</span><span style=color:#c2d94c>'public:landing-page'</span><span>)
</span><span>        form </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>app</span><span style=color:#f29668>.</span><span style=color:#ffb454>get</span><span>(url)</span><span style=color:#f29668>.</span><span>form
</span><span>        form[</span><span style=color:#c2d94c>'email'</span><span>] </span><span style=color:#f29668>= </span><span style=color:#c2d94c>'easyabc.com'
</span><span>        response </span><span style=color:#f29668>= </span><span>form</span><span style=color:#f29668>.</span><span style=color:#ffb454>submit</span><span>()</span><span style=color:#f29668>.</span><span style=color:#ffb454>follow</span><span>()
</span><span>
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertEqual</span><span>(Interest</span><span style=color:#f29668>.</span><span>objects</span><span style=color:#f29668>.</span><span style=color:#ffb454>count</span><span>()</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)
</span><span>        </span><span style=font-style:italic;color:#5c6773># you could look in the dom for your error class or just use assertTemplateUsed instead
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertContains</span><span>(response</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'invalid'</span><span>)
</span></code></pre><p>If I wanted to be logged in, I would just need to pass my user object as a parameter to the get, ie self.app.get(url, user=self.user) for example.<h3 id=mocking>Mocking</h3><p>Sometimes you want to mock things it out. Things like call to a 3rd party service that can take time and require an internet connection. You do not want to mock your own services though unless you have proper integration tests somewhere. In the following example, I will mock a method from the Stripe API to prevent it from actually calling Stripe.<pre class=language-python data-lang=python style=background:#0f1419;color:#bfbab0><code class=language-python data-lang=python><span>    </span><span style=color:#bfbab0cc>@</span><span style=color:#ffb454>patch</span><span>(</span><span style=color:#c2d94c>'stripe.Customer.retrieve'</span><span>)
</span><span>    </span><span style=color:#bfbab0cc>@</span><span>patch</span><span style=color:#f29668>.</span><span style=color:#ffb454>object</span><span>(stripe</span><span style=color:#f29668>.</span><span>Customer</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>'update_subscription'</span><span>)
</span><span>    </span><span style=color:#ff7733>def </span><span style=color:#ffb454>test_subscribe_different_subscription</span><span>(</span><span style=color:#f29718>self</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>UpdateSubscriptionMock</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>CustomerRetrieveMock</span><span>):
</span><span>        </span><span style=font-style:italic;color:#5c6773>"""
</span><span style=font-style:italic;color:#5c6773>        Changing to a different plan (or no previous plan) should call
</span><span style=font-style:italic;color:#5c6773>        Stripe and save it locally
</span><span style=font-style:italic;color:#5c6773>        """
</span><span>        CustomerRetrieveMock</span><span style=color:#f29668>.</span><span>return_value </span><span style=color:#f29668>= </span><span>StripeTest</span><span style=color:#f29668>.</span><span style=color:#ffb454>get_customer_response</span><span>()
</span><span>        UpdateSubscriptionMock</span><span style=color:#f29668>.</span><span>return_value </span><span style=color:#f29668>= </span><span>StripeTest</span><span style=color:#f29668>.</span><span style=color:#ffb454>get_subscription_response</span><span>()
</span><span>
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>_subscribe_user</span><span>()
</span><span>        </span><span style=color:#ffb454>StripePlanFactory</span><span>(</span><span style=color:#f29718>code</span><span style=color:#f29668>=</span><span style=color:#c2d94c>'big'</span><span>)
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span>customer</span><span style=color:#f29668>.</span><span style=color:#ffb454>subscribe</span><span>(</span><span style=color:#c2d94c>'big'</span><span>)
</span><span>
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertTrue</span><span>(CustomerRetrieveMock</span><span style=color:#f29668>.</span><span>called)
</span><span>        </span><span style=font-style:italic;color:#39bae6>self</span><span style=color:#f29668>.</span><span style=color:#ffb454>assertTrue</span><span>(UpdateSubscriptionMock</span><span style=color:#f29668>.</span><span>called)
</span></code></pre><p>Mocking 2 things here :<ul><li>a class method (stripe.Customer.retrieve)<li>a method (update_subscription of stripe.Customer)</ul><p>To accomplish that, you just need to add the right decorators (look into the doc for more info), add the mocks in the test parameters (order matters of course) and then define a return_value to these mocks. At the end of the tests I'm just making sure both methods were called and that's it.<h2 id=conclusion>Conclusion</h2><p>That's it for how I test django apps, if you want more details or have better ideas, feel free to ask/share !</section></article></main></div>