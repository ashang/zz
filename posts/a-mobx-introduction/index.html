<!doctype html><html class="dark light"><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><title>
         A MobX introduction and case study
        
    </title><meta content="A MobX introduction and case study" property=og:title><meta content="Getting started with MobX and a case study" property=og:description><meta content="Getting started with MobX and a case study" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://ashang.github.io/zz/fonts.css rel=stylesheet><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}}</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://ashang.github.io/zz/atom.xml rel=alternate title=atbb type=application/atom+xml><link href=https://ashang.github.io/zz/theme/light.css rel=stylesheet><link href=https://ashang.github.io/zz/theme/dark.css id=darkModeStyle rel=stylesheet><link href=https://ashang.github.io/zz/main.css media=screen rel=stylesheet><body><div class=content><header><div class=main><a href=https://ashang.github.io/zz/>atbb</a><div class=socials><a class=social href=https://github.com/ashang/ rel=me> <img alt=github src=/social_icons/github.svg> </a></div></div><nav><a href=$BASE_URL/search/ style=margin-left:.7em>Search</a><a href=/notes style=margin-left:.7em>/notes</a><a href=/posts style=margin-left:.7em>/posts</a><a href=/gallery style=margin-left:.7em>/gallery</a><a href=/tags style=margin-left:.7em>/tags</a><a href=/projects style=margin-left:.7em>/projects</a> | <a href=javascript:void(0) id=dark-mode-toggle onclick=toggleTheme()> <img id=sun-icon src=/feather/sun.svg style=filter:invert(1)> <img id=moon-icon src=/feather/moon.svg> </a><script src=https://ashang.github.io/zz/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>A MobX introduction and case study<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2016-11-01</time></div></div><h1>Table of Contents</h1><ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#what-is-mobx-and-why-should-i-look-into-it>What is MobX and why should I look into it</a> <ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#mobx>MobX?</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#why-would-i-use-it-instead-of-redux-immutablejs-or-library-x>Why would I use it instead of Redux/ImmutableJS or library X?</a></ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#mobx-by-example>MobX by example</a> <ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#observing-arrays-and-map-changes-with-autorun>Observing arrays and map changes with autorun</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#observing-class-properties-and-transactions>Observing class properties and transactions</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#computed-values>Computed values</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#actions>Actions</a></ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#mobx-in-real-life>MobX in real life</a> <ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#stores>Stores</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#components>Components</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#dev-tools>Dev tools</a></ul><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#useful-links>Useful links</a><li><a href=https://ashang.github.io/zz/posts/a-mobx-introduction/#conclusion>Conclusion</a></ul><section class=body><p><a href=https://mobxjs.github.io/mobx/>MobX</a> (previously mobservable) is a state management library for JavaScript frontend application. This article introduces it with examples as well as showing how it works in a real app with TypeScript. It is based on a talk I gave at the Osaka Web designers and developers meetup recently.<h2 id=what-is-mobx-and-why-should-i-look-into-it>What is MobX and why should I look into it</h2><h3 id=mobx>MobX?</h3><p>Let's start by explaining what is MobX and how it works. It's presented as using Transparent Functional Reactive Programming.<p>Now, FRP is a very controversial term as everyone seems to have their own definition so let's forget about that and look at a illustration from the MobX docs (click on it to open in a new tab and get full size or open <a href=https://ashang.github.io/zz/posts/a-mobx-introduction/mobx-flow.png>this link</a>).</p><img alt="MobX flow" srcset="https://ashang.github.io/zz/processed_images/mobx-flow.a0f09e6ca2b6a43c.png 512w, https://ashang.github.io/zz/processed_images/mobx-flow.c506f1410d923a0e.png 1024w" title="MobX flow" src=https://ashang.github.io/zz/processed_images/mobx-flow.c506f1410d923a0e.png><p>In short, actions modify the state, which triggers reactions. Part of the state can be derived automatically, such as the number of tasks left to do in a TODO list to take the example of the picture above. What sets MobX apart from other Observable implementations is the transparent part. Reactions observe which observables you are using and subscribe to them automatically, without you having to explicitely subscribe to those.<p>Before we continue, a few more things:<ul><li>while some of the examples use React, MobX is not tied to any particular framework<li>it is written in TypeScript so you get type definitions out of the box if you are using TypeScript<li>the learning curve is very small and you will be able to start an app by the end of that article</ul><h3 id=why-would-i-use-it-instead-of-redux-immutablejs-or-library-x>Why would I use it instead of Redux/ImmutableJS or library X?</h3><p>This part is written from my experience using both Redux/ImmutableJS and MobX with React in Proppy, our app to write proposals for freelancers and small agencies/companies. Its frontend is written in TypeScript, which was one of a big reason to moving to MobX as we will see in a bit.<p>Our issues with Redux/ImmutableJS were twofold.<p>The first issue was that it is very verbose. You need to write an action, the reducer function, a selector and then connect the actions and the data on the React components.<p>The second issue only occurs if you are using TypeScript like us. You also need to add the types of actions and data at each step and sometimes even repeat them if you are passing down actions to dumb components. We were also using ImmutableJS records with maps in them which meant the code was very often stringly typed. For example, getting a value using <code>.getIn(["blocks", id, "data", "value"])</code> was common and there was no typecheck whatsoever.<p>With MobX we only have to mention the types and, as we will see when showing examples of Proppy, get full typechecking as we are only dealing with plain JavaScript objects.<p>Note that using MobX means you have to give up immutability, which could be a showstopper for you.<h2 id=mobx-by-example>MobX by example</h2><p>This section is a brief introduction to MobX. If you have already used it, you can safely skip to the next section to see some patterns/snippets from a live application.<p>Note that I will use ES6 syntax and decorators throughout the examples but it works in plain ES5 as well.<h3 id=observing-arrays-and-map-changes-with-autorun>Observing arrays and map changes with autorun</h3><p>Let's start with observing arrays and maps, as it constitutes a big chunk of what we would want to observe.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ff7733>import </span><span>{ observable</span><span style=color:#bfbab0cc>, </span><span>asMap</span><span style=color:#bfbab0cc>, </span><span>autorun } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"mobx"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=font-style:italic;color:#5c6773>// becomes an ObservableArray (same API as normal array)
</span><span style=color:#ff7733>const </span><span>numbers </span><span style=color:#f29668>= </span><span style=color:#ffb454>observable</span><span>([</span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>,</span><span style=color:#f29718>3</span><span>])</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// becomes an ObservableMap (same API as Map)
</span><span style=color:#ff7733>const </span><span>users </span><span style=color:#f29668>= </span><span style=color:#ffb454>observable</span><span>(</span><span style=color:#ffb454>asMap</span><span>({</span><span style=color:#c2d94c>"bob"</span><span style=color:#bfbab0cc>: </span><span style=color:#c2d94c>"bob"</span><span>}))</span><span style=color:#bfbab0cc>;
</span></code></pre><p>To show the changes to observable values, we will use the <code>autorun</code> function provided by the mobx package. This function takes a function as argument and call it once to detect which observables are being used in it and subscribe to them.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ffb454>autorun</span><span>(() </span><span style=color:#ff7733>=> </span><span>{
</span><span>  </span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(</span><span style=color:#c2d94c>"autorun!"</span><span style=color:#bfbab0cc>, </span><span>numbers</span><span style=color:#f29668>.</span><span style=color:#ffb454>toJS</span><span>()</span><span style=color:#bfbab0cc>, </span><span>users</span><span style=color:#f29668>.</span><span style=color:#ffb454>toJS</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>})</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// initial run: prints autorun! [1,2,3] {"bob": "bob"}
</span><span>numbers</span><span style=color:#f29668>.</span><span style=color:#f07178>push</span><span>(</span><span style=color:#f29718>4</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// prints autorun! [1,2,3,4] {"bob": "bob"}
</span><span>users</span><span style=color:#f29668>.</span><span style=color:#f07178>set</span><span>(</span><span style=color:#c2d94c>"jane"</span><span style=color:#bfbab0cc>, </span><span style=color:#c2d94c>"jane"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// prints autorun! [1,2,3,4] {"bob": "bob", "jane": "jane"}
</span></code></pre><p>We will show in the next section that <code>autorun</code> doesn't actually run everytime any observable is modified like the example above might indicate but only when one of those used in the function are modified.<h3 id=observing-class-properties-and-transactions>Observing class properties and transactions</h3><p>The other thing that we typically want to observe are class properties.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ff7733>import </span><span>{ observable</span><span style=color:#bfbab0cc>, </span><span>autorun } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"mobx"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#ff7733>class </span><span style=color:#59c2ff>Meetup </span><span>{
</span><span>  @observable name</span><span style=color:#bfbab0cc>;
</span><span>  @observable numberPeople</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=color:#ff7733>constructor</span><span>(</span><span style=color:#f29718>name</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>numberPeople</span><span>) {
</span><span>    </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>name </span><span style=color:#f29668>= </span><span>name</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>= </span><span>numberPeople</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span><span>
</span><span>
</span><span style=color:#ff7733>const </span><span>thisMeetup </span><span style=color:#f29668>= new </span><span style=color:#59c2ff>Meetup</span><span>(</span><span style=color:#c2d94c>"Osaka Web designers and developers"</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>0</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=color:#ffb454>autorun</span><span>(() </span><span style=color:#ff7733>=> </span><span>{
</span><span>  </span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(thisMeetup</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>+ </span><span style=color:#c2d94c>" people"</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>})</span><span style=color:#bfbab0cc>;
</span><span>thisMeetup</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>= </span><span style=color:#f29718>1</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// prints "1 people"
</span></code></pre><p>In that example, both <code>name</code> and <code>numberPeople</code> are observable properties of the <code>thisMeetup</code> object but only <code>numberPeople</code> is used in the <code>autorun</code> function. Therefore, the following snippet will not print anything:<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span>thisMeetup</span><span style=color:#f29668>.</span><span>name </span><span style=color:#f29668>= </span><span style=color:#c2d94c>"Hello"</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// doesn't print anything
</span></code></pre><p>Remember the T part of TFRP? MobX automatically figured out which observable to subscribe to and has done so transparently.<p>Reactions are synchronous so you might wonder how to avoid "useless" reactions, e.g. when setting multiple observables at once such as when receiving a response from a AJAX request. <code>transaction</code> solves that issue by not triggering reactions until the end of the function.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ffb454>transaction</span><span>(() </span><span style=color:#ff7733>=> </span><span>{
</span><span>  thisMeetup</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>= </span><span style=color:#f29718>2</span><span style=color:#bfbab0cc>;
</span><span>  thisMeetup</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>= </span><span style=color:#f29718>3</span><span style=color:#bfbab0cc>;
</span><span>  thisMeetup</span><span style=color:#f29668>.</span><span>numberPeople </span><span style=color:#f29668>= </span><span style=color:#f29718>4</span><span style=color:#bfbab0cc>;
</span><span>})</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// print "4 people"
</span></code></pre><p>In the example above, <code>autorun</code> only runs once: with <code>numberPeople</code> equal to 4, not with the intermediate 2 and 3.<h3 id=computed-values>Computed values</h3><p>In some cases, data can be derived directly from the state. To take a simplified example from Proppy, we are going to look at a row in a cost table: we have quantity and unit price and can therefore automatically calculate the total. <code>computed</code> is lazy (won't be evaluated unless needed in a reaction) and it is memoized (if the observables used inside didn't change, it doesn't need to re-run and can return the current value).<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ff7733>class </span><span style=color:#59c2ff>TableRow </span><span>{
</span><span>  @observable quantity </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>  @observable price </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=color:#ff7733>constructor</span><span>(</span><span style=color:#f29718>price</span><span>) {
</span><span>    </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>price </span><span style=color:#f29668>= </span><span>price
</span><span>  }
</span><span>
</span><span>  </span><span style=font-style:italic;color:#5c6773>// a getter
</span><span>  @computed </span><span style=color:#ff7733>get </span><span style=color:#ffb454>total</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>price </span><span style=color:#f29668>* </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>quantity</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#ff7733>const </span><span>row </span><span style=color:#f29668>= new </span><span style=color:#59c2ff>TableRow</span><span>(</span><span style=color:#f29718>10</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// prints 0 (since 10x0=0)
</span><span>row</span><span style=color:#f29668>.</span><span>quantity </span><span style=color:#f29668>= </span><span style=color:#f29718>10</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// Only computed on the call
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// prints 100
</span><span style=font-style:italic;color:#5c6773>// Not recomputed if the observables used didn't change
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)
</span><span style=font-style:italic;color:#5c6773>// prints 100
</span></code></pre><p>Note that <code>@computed</code> can only be used on <a href=https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Functions/get>getter</a> in a class.<h3 id=actions>Actions</h3><p>Actions are functions that modify the state. While, as shown in the previous examples, we can simply modify the object directly, it is not the recommended way to do so.<p>The recommended way is to wrap any actions that modify the state with the <code>action</code> function or decorator. This will accomplish a few things:<ul><li>wrap the function in a transaction automatically<li>provide debugging info for that state change that can be displayed in dev tools</ul><p>You can force your app to only modify state through actions by using <code>useStrict(true)</code> in your app.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ffb454>useStrict</span><span>(</span><span style=color:#f29718>true</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#ff7733>class </span><span style=color:#59c2ff>TableRow </span><span>{
</span><span>  @observable quantity </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>  price </span><span style=color:#f29668>= </span><span style=color:#f29718>0</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=color:#ff7733>constructor</span><span>(</span><span style=color:#f29718>price</span><span>) {
</span><span>    </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>price </span><span style=color:#f29668>= </span><span>price
</span><span>  }
</span><span>
</span><span>  </span><span style=font-style:italic;color:#5c6773>// a getter
</span><span>  @computed </span><span style=color:#ff7733>get </span><span style=color:#ffb454>total</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>price </span><span style=color:#f29668>* </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>quantity</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  @action </span><span style=color:#ffb454>setQuantity</span><span>(</span><span style=color:#f29718>quantity</span><span>) {
</span><span>    </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>quantity </span><span style=color:#f29668>= </span><span>quantity</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#ff7733>const </span><span>row </span><span style=color:#f29668>= new </span><span style=color:#59c2ff>TableRow</span><span>(</span><span style=color:#f29718>10</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)</span><span style=color:#bfbab0cc>;
</span><span>row</span><span style=color:#f29668>.</span><span style=color:#ffb454>setQuantity</span><span>(</span><span style=color:#f29718>10</span><span>)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// Only computed on the call
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// Not recomputed if the observables used didn't change
</span><span style=font-style:italic;color:#39bae6>console</span><span style=color:#f29668>.</span><span style=color:#f07178>log</span><span>(row</span><span style=color:#f29668>.</span><span>total)</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=font-style:italic;color:#5c6773>// Use `useStrict` to force state to only be modified in `action` fns
</span><span>row</span><span style=color:#f29668>.</span><span>quantity </span><span style=color:#f29668>= </span><span style=color:#f29718>10</span><span style=color:#bfbab0cc>; </span><span style=font-style:italic;color:#5c6773>// will error
</span></code></pre><p>We don't use the strict mode ourselves<h2 id=mobx-in-real-life>MobX in real life</h2><p>Now that you know the basics of MobX, it's time to see how it looks in production. It's currently the backbone of our frontend app in Proppy so we will use examples from it.<p>If you are doing SSR, be aware that the way we handle stores shown below will not work for you.<p>Converting Proppy to use MobX took about 4 days, numerous long-standing issues were fixed along the way and the end result was a deletion of around 1000 to 2000 lines (estimate as we also moved to use npm @types for typings in that branch).<h3 id=stores>Stores</h3><p>Our stores are simple singleton classes that have observable properties. Here's a shorter version of one of our stores, dealing with clients for proposals.<pre class=language-js data-lang=js style=background:#0f1419;color:#bfbab0><code class=language-js data-lang=js><span style=color:#ff7733>import </span><span>{ observable</span><span style=color:#bfbab0cc>, </span><span>action</span><span style=color:#bfbab0cc>, </span><span>map</span><span style=color:#bfbab0cc>, </span><span>transaction</span><span style=color:#bfbab0cc>, </span><span>ObservableMap } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"mobx"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=font-style:italic;color:#5c6773>// a class definition with types
</span><span style=color:#ff7733>import </span><span>{ Client } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"./models/Client"</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>import </span><span>fetchling </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"../utils/fetchling"</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>import </span><span>uiStore </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"./UIStore"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#ff7733>export class </span><span style=color:#59c2ff>ClientStore </span><span>{
</span><span>  @observable clients</span><span style=color:#f29668>: </span><span style=color:#59c2ff>ObservableMap</span><span><</span><span style=color:#59c2ff>Client</span><span>> </span><span style=color:#f29668>= </span><span style=color:#ffb454>map</span><span><</span><span style=color:#59c2ff>Client</span><span>>()</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=color:#ffb454>getClient</span><span>(</span><span style=color:#f29718>id</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>number</span><span>) {
</span><span>    </span><span style=color:#ff7733>return </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>clients</span><span style=color:#f29668>.</span><span style=color:#f07178>get</span><span>(id</span><span style=color:#f29668>.</span><span style=color:#f07178>toString</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  @action </span><span style=color:#ffb454>fetchAll</span><span>()</span><span style=color:#f29668>: </span><span style=color:#59c2ff>Promise</span><span><</span><span style=font-style:italic;color:#39bae6>any</span><span>> {
</span><span>    </span><span style=color:#ff7733>return </span><span style=color:#ffb454>fetchling</span><span>(</span><span style=color:#c2d94c>"/clients"</span><span>)</span><span style=color:#f29668>.</span><span style=color:#f07178>get</span><span>()</span><span style=color:#f29668>.</span><span style=color:#f07178>then</span><span>((</span><span style=color:#f29718>response</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>any</span><span>) </span><span style=color:#ff7733>=> </span><span>{
</span><span>      </span><span style=color:#ffb454>transaction</span><span>(() </span><span style=color:#ff7733>=> </span><span>{
</span><span>        </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span style=color:#ffb454>setClients</span><span>(response</span><span style=color:#f29668>.</span><span>clients)</span><span style=color:#bfbab0cc>;
</span><span>      })</span><span style=color:#bfbab0cc>;
</span><span>    })</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  @action </span><span style=color:#ffb454>deleteClient</span><span>(</span><span style=color:#f29718>clientId</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>number</span><span>) {
</span><span>    </span><span style=color:#ff7733>const </span><span>client </span><span style=color:#f29668>= </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>clients</span><span style=color:#f29668>.</span><span style=color:#f07178>get</span><span>(clientId</span><span style=color:#f29668>.</span><span style=color:#f07178>toString</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>    </span><span style=color:#ff7733>return </span><span style=color:#ffb454>fetchling</span><span>(</span><span style=color:#c2d94c>`/clients/${</span><span>clientId</span><span style=color:#c2d94c>}`</span><span>)</span><span style=color:#f29668>.</span><span style=color:#f07178>delete</span><span>()
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>then</span><span>(() </span><span style=color:#ff7733>=> </span><span>{
</span><span>        </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>clients</span><span style=color:#f29668>.</span><span style=color:#f07178>delete</span><span>(clientId</span><span style=color:#f29668>.</span><span style=color:#f07178>toString</span><span>())</span><span style=color:#bfbab0cc>;
</span><span>        uiStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>notify</span><span>(</span><span style=color:#c2d94c>`Client deleted`</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>false</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      })
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>catch</span><span>(() </span><span style=color:#ff7733>=> </span><span>uiStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>notify</span><span>(</span><span style=color:#c2d94c>`Client ${</span><span>client</span><span style=color:#f29668>.</span><span style=color:#c2d94c>name} could not be deleted. Please try again later`</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>false</span><span>))</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  @action </span><span style=color:#ffb454>updateClient</span><span>(</span><span style=color:#f29718>clientId</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>number</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>name</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>string</span><span>) {
</span><span>    </span><span style=color:#ff7733>return </span><span style=color:#ffb454>fetchling</span><span>(</span><span style=color:#c2d94c>`/clients/${</span><span>clientId</span><span style=color:#c2d94c>}`</span><span>)</span><span style=color:#f29668>.</span><span style=color:#ffb454>put</span><span>({name})
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>then</span><span>((</span><span style=color:#f29718>response</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>any</span><span>) </span><span style=color:#ff7733>=> </span><span>{
</span><span>        </span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span>clients</span><span style=color:#f29668>.</span><span style=color:#f07178>set</span><span>(clientId</span><span style=color:#f29668>.</span><span style=color:#f07178>toString</span><span>()</span><span style=color:#bfbab0cc>, </span><span style=color:#f29668>new </span><span style=color:#59c2ff>Client</span><span>(response</span><span style=color:#f29668>.</span><span>client))</span><span style=color:#bfbab0cc>;
</span><span>        uiStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>notify</span><span>(</span><span style=color:#c2d94c>`Client updated`</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>false</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>      })
</span><span>      </span><span style=color:#f29668>.</span><span style=color:#f07178>catch</span><span>(</span><span style=color:#f29718>response </span><span style=color:#ff7733>=> </span><span>{
</span><span>        uiStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>notify</span><span>(</span><span style=color:#c2d94c>`Client could not be updated. Please try again later`</span><span style=color:#bfbab0cc>, </span><span style=color:#f29718>true</span><span>)</span><span style=color:#bfbab0cc>;
</span><span>        </span><span style=color:#ff7733>if </span><span>(response</span><span style=color:#f29668>.</span><span>errors) {
</span><span>          </span><span style=color:#ff7733>return </span><span>response</span><span style=color:#f29668>.</span><span>errors</span><span style=color:#f29668>.</span><span>errors</span><span style=color:#bfbab0cc>;
</span><span>        }
</span><span>      })</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#ff7733>const </span><span>clientStore </span><span style=color:#f29668>= new </span><span style=color:#59c2ff>ClientStore</span><span>()</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>export default </span><span>clientStore</span><span style=color:#bfbab0cc>;
</span></code></pre><p>Quite simple stuff. You can see we are calling another store from our store. That would be a big no-no in Redux and we were using a middleware to solve that previously. It feels much nicer now: we have a full view of what's happening and it's very easy to see if something is missing (which was actually the case for some ajax requests).<p>This example doesn't really show it but every data stored in a store is typed and trying to access <code>client.random</code> would be a compiler error. It really shines for complex objects like cost tables that were previously a simple map with no schema and are now fully typed objects with functions of their own. Thanks to that, we moved things such as calculating totals to the cost table class rather than a React component like before.<h3 id=components>Components</h3><p>We're using the <code>mobx-react</code> package that gives us the <code>observer</code> decorator that we put on top of a component. Doing so gives us the same thing as the <code>autorun</code> in the MobX by example section: when an observable used in the <code>render</code> function changes, the component will be re-rendered. <code>@observer</code> also comes with an optimized <code>shouldComponentUpdate</code> that works very well in our experience: the only <code>shouldComponentUpdate</code> left in our code are the ones impossible to not handle manually due to <code>contenteditable</code>.<p>Since we don't do server side rendering, we can directly import a store and call its function directly. Here's a slightly modified code sample for the Settings>Clients page:<pre class=language-tsx data-lang=tsx style=background:#0f1419;color:#bfbab0><code class=language-tsx data-lang=tsx><span style=color:#ff7733>import </span><span style=color:#f29718>* </span><span style=color:#ff7733>as </span><span>React  </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"react"</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>import </span><span>{ observer } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"mobx-react"</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>import </span><span>{ observable } </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"mobx"</span><span style=color:#bfbab0cc>;
</span><span>
</span><span style=color:#ff7733>import </span><span>companyStore </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"../../stores/CompanyStore"</span><span style=color:#bfbab0cc>;
</span><span style=color:#ff7733>import </span><span>clientStore </span><span style=color:#ff7733>from </span><span style=color:#c2d94c>"../../stores/ClientStore"</span><span style=color:#bfbab0cc>;
</span><span style=font-style:italic;color:#5c6773>// ... some component import
</span><span>
</span><span>@observer
</span><span style=color:#ff7733>export class </span><span style=color:#59c2ff>Clients </span><span style=color:#ff7733>extends </span><span style=color:#59c2ff>React</span><span style=color:#f29668>.</span><span style=text-decoration:underline;color:#59c2ff>Component</span><span><{}</span><span style=color:#bfbab0cc>, </span><span>{}> {
</span><span>  </span><span style=font-style:italic;color:#5c6773>// not used, only here for the sake of example
</span><span>  @observable clientAdded</span><span style=color:#f29668>: </span><span style=font-style:italic;color:#39bae6>boolean </span><span style=color:#f29668>= </span><span style=color:#f29718>false</span><span style=color:#bfbab0cc>;
</span><span>
</span><span>  </span><span style=font-style:italic;color:#5c6773>// Our async loaded component will call that function and wait until
</span><span>  </span><span style=font-style:italic;color:#5c6773>// the promises complete to render that component
</span><span>  </span><span style=color:#ff7733>static </span><span style=color:#ffb454>fetchData</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span style=font-style:italic;color:#39bae6>Promise</span><span style=color:#f29668>.</span><span style=color:#f07178>all</span><span>([
</span><span>      companyStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>fetchUs</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>      clientStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>fetchAll</span><span>()</span><span style=color:#bfbab0cc>,
</span><span>    ])</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#ffb454>renderClients</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span>clientStore</span><span style=color:#f29668>.</span><span>clients</span><span style=color:#f29668>.</span><span style=color:#f07178>values</span><span>()</span><span style=color:#f29668>.</span><span style=color:#ffb454>map</span><span>(</span><span style=color:#f29718>client </span><span style=color:#ff7733>=> </span><span>{
</span><span>      </span><span style=color:#ff7733>return </span><span>(
</span><span>        </span><span style=color:#39bae690><</span><span style=color:#59c2ff>div </span><span style=color:#ffb454>className</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"client" </span><span style=color:#ffb454>key</span><span style=color:#f29668>=</span><span>{client</span><span style=color:#f29668>.</span><span>id}</span><span style=color:#39bae690>>
</span><span>          </span><span style=color:#39bae690><</span><span style=color:#59c2ff>span </span><span style=color:#ffb454>onClick</span><span style=color:#f29668>=</span><span>{() </span><span style=color:#ff7733>=> </span><span>clientStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>deleteClient</span><span>(client</span><span style=color:#f29668>.</span><span>id)} </span><span style=color:#ffb454>className</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"icon-delete" </span><span style=color:#39bae690>/>
</span><span>          </span><span style=color:#39bae690><</span><span style=font-style:italic;color:#39bae6>InlineInput
</span><span>            </span><span style=color:#ffb454>value</span><span style=color:#f29668>=</span><span>{client</span><span style=color:#f29668>.</span><span>name}
</span><span>            </span><span style=color:#ffb454>onEnter</span><span style=color:#f29668>=</span><span>{(</span><span style=color:#f29718>value</span><span>) </span><span style=color:#ff7733>=> </span><span>clientStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>updateClient</span><span>(client</span><span style=color:#f29668>.</span><span>id</span><span style=color:#bfbab0cc>, </span><span>value)} </span><span style=color:#39bae690>/>
</span><span>        </span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>div</span><span style=color:#39bae690>>
</span><span>      )</span><span style=color:#bfbab0cc>;
</span><span>    })</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#ffb454>renderForm</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span>(
</span><span>      </span><span style=color:#39bae690><</span><span style=font-style:italic;color:#39bae6>InAppForm
</span><span>        </span><span style=color:#ffb454>inline</span><span style=color:#f29668>=</span><span>{</span><span style=color:#f29718>true</span><span>}
</span><span>        </span><span style=color:#ffb454>resetOnSuccess
</span><span>        </span><span style=color:#ffb454>submitText</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"Add client"
</span><span>        </span><span style=color:#ffb454>onSubmit</span><span style=color:#f29668>=</span><span>{(</span><span style=color:#f29718>data</span><span>) </span><span style=color:#ff7733>=> </span><span>clientStore</span><span style=color:#f29668>.</span><span style=color:#ffb454>createClient</span><span>(data)} </span><span style=color:#39bae690>/>
</span><span>    )</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>  </span><span style=color:#ffb454>render</span><span>() {
</span><span>    </span><span style=color:#ff7733>return </span><span>(
</span><span>      </span><span style=color:#39bae690><</span><span style=font-style:italic;color:#39bae6>SettingsContainer</span><span style=color:#39bae690>>
</span><span>        </span><span style=color:#39bae690><</span><span style=color:#59c2ff>div </span><span style=color:#ffb454>className</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"clients"</span><span style=color:#39bae690>>
</span><span>          </span><span style=color:#39bae690><</span><span style=color:#59c2ff>h2</span><span style=color:#39bae690>></span><span>Manage {your} clients</span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>h2</span><span style=color:#39bae690>>
</span><span>          {</span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span style=color:#ffb454>renderForm</span><span>()}
</span><span>          </span><span style=color:#39bae690><</span><span style=color:#59c2ff>div </span><span style=color:#ffb454>className</span><span style=color:#f29668>=</span><span style=color:#c2d94c>"clients-list"</span><span style=color:#39bae690>>
</span><span>            {</span><span style=font-style:italic;color:#39bae6>this</span><span style=color:#f29668>.</span><span style=color:#ffb454>renderClients</span><span>()}
</span><span>          </span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>div</span><span style=color:#39bae690>>
</span><span>        </span><span style=color:#39bae690>&LT/</span><span style=color:#59c2ff>div</span><span style=color:#39bae690>>
</span><span>      </span><span style=color:#39bae690>&LT/</span><span style=font-style:italic;color:#39bae6>SettingsContainer</span><span style=color:#39bae690>>
</span><span>    )</span><span style=color:#bfbab0cc>;
</span><span>  }
</span><span>}
</span></code></pre><p>No ceremony needed, everything works out of the box as if I was just dealing with plain JavaScript objects. All the store functions and data are typed too. Trying to call <code>clientStore.deleteClient("1")</code> for example would be a compilation error and I only had to write the type once: in the store as shown before.<p>Another aspect not mentioned before is that you can also use <code>observable</code> to remove the need for React state.<p>Rather than having a state and updating it with <code>this.setState</code>, you can just update your variable directly and it will re-render the component if that property is used in the render method. To use the previous example, if I wanted to display a banner after adding a client in that component I could set <code>this.client = true</code> and render something different when <code>this.client</code> is true. No more <code>this.setState({..} as any)</code> to satisfy the TypeScript compiler. Another neat thing about using MobX for state is that changes will be logged if you are using dev tools.<h3 id=dev-tools>Dev tools</h3><p>For React, <code>mobx-react-devtools</code> is available and is pretty great. See the gif below from its repo to have an overview of the 3 features.</p><img alt="React MobX devtools" srcset="https://ashang.github.io/zz/processed_images/devtools.87944b92a79e2c5b.jpg 512w" title="React MobX devtools" src=https://ashang.github.io/zz/processed_images/devtools.462eb305623d6c38.jpg><p>I have mostly used the logging to inspect action and state changes while debugging and to spot erroneous updates and the re-rendering highlighter to figure out if some of our components were re-rendering too often.<h2 id=useful-links>Useful links</h2><ul><li><a href=https://mobxjs.github.io/mobx/>Official docs</a> and in particular <a href=https://mobxjs.github.io/mobx/best/pitfalls.html>Common pitfalls & best practices</a> and <a href=https://mobxjs.github.io/mobx/best/react.html>What does MobX reacts to?</a><li><a href=https://medium.com/@mweststrate/becoming-fully-reactive-an-in-depth-explanation-of-mobservable-55995262a254>In-depth explanation of MobX</a><li><a href=https://github.com/mobxjs/mobx/issues/199>Understanding MobX and when to use it</a><li><a href=https://github.com/mobxjs/mobx/issues/104>Example: real-life with router/ajax etc</a></ul><h2 id=conclusion>Conclusion</h2><p>Overall, we are very happy with the transition to MobX and would recommend investigating it if you are looking for a state management solution, especially if you are using TypeScript or Flow. I'm pretty impressed by the constant work the TypeScript team has accomplished and highly recommend it as well if you are planning to stay on the JavaScript side and not go for Elm/PureScript/etc.</section></article></main></div>